<!DOCTYPE HTML>
<html lang="en">
<head>
    <meta charset="utf-8">
    <script src="../../lib/jquery-2.0.3.js"></script>
    <script src="vendor/mocha.js"></script>
    <script src="vendor/require.js"></script>
    <script src="config.js"></script>
	<script src="vendor/jquery.tabbable.js"></script>
</head>
<body>

<!--PLACEHOLDER FOR MOCHA TEST RESULTS-->
<div id="mocha"></div>

<!--FIXTURE HTML FOR TESTS-->
<div id="spec-markup">
	<h4>Text Links</h4>
	<ul>
		<li><a id="lightbox-demo-text-link-for-small-lightbox" href="#" data-skyLightbox="#lightbox-demo-small">Small Lightbox</a></li>
		<li><a id="lightbox-demo-text-link-for-large-lightbox" href="#" data-skyLightbox="#lightbox-demo">Large Lightbox</a></li>
	</ul>
	<h4>Image Links</h4>
	<ul>
		<li>Small Lightbox</li>
		<li>Large Lightbox</li>
	</ul>

	<div id="lightbox-text-link-small-lightbox">

	</div>

	<div id="lightbox-demo" class="lightbox">
		<div class="skycom-container">
			<article class="skycom-10 skycom-offset1 lightbox-content" role="dialog" aria-labelledby="lightbox-demo-text-link-for-large-lightbox">
				<a class="lightbox-close skycon-close" href="#">
					<span class="speak">Close</span>
				</a>
				<!-- Note you can use the sky-grid in lightboxs -->
				<div class="skycom-container clearfix">
					<div class="skycom-7 alpha">
						<h2>Large Lightbox</h2>

						<p>Lorem ipsum dolor sit amet</p>

						<p>
							Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod
							tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud
							exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in
							reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint
							occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.
						</p>

						Text: <input id="lightboxInput" type="text" placeholder="focusable input">

						<p style="margin-bottom: 16px;">
							Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod
							tempor incididunt ut labore et dolore magna aliqua.
						</p>
					</div>

					<div class="skycom-5">
						<h3>Other Links</h3>

						<ul>
							<li><a href="#">Lorem Ipsum</a></li>
							<li><a href="#">Dolor sit amet</a></li>
						</ul>
					</div>
				</div>
			</article>
		</div>
	</div>

</div>


<!--TEST-->
<script>

    require(['modules/lightbox', '../../test/jsUnit/setup'], function () {

		$('.lightbox').skyLightbox();

		describe('Lightbox module', function() {

			beforeEach(function() {
				$('.lightbox').removeClass('lightbox-open');
				$('#lightbox-demo-text-link-for-large-lightbox').removeClass('skycom-focus');
				$('body').removeAttr('style');
			});

			var givenTheLargeLightBoxIsOpen = function() {
				$('#lightbox-demo-text-link-for-large-lightbox').click();
				expect($('#lightbox-demo').hasClass('lightbox-open')).to.equal(true);
			};


			it('Displays a lightbox when a user clicks a text link', function() {
				// given
				expect($('#lightbox-demo').hasClass('lightbox-open')).to.equal(false);
				// when
				$('#lightbox-demo-text-link-for-large-lightbox').click();
				// then
                expect($('#lightbox-demo').hasClass('lightbox-open')).to.equal(true);
            });


			it('Closes when the close icon is clicked', function() {
				givenTheLargeLightBoxIsOpen();
				// when
				$('#lightbox-demo .lightbox-close').click();
				// then
				expect($('#lightbox-demo').hasClass('lightbox-open')).to.equal(false);
			});


			it('Closes when the faded grey bit is clicked', function() {
				givenTheLargeLightBoxIsOpen();
				// when
				$('#lightbox-demo').click();
				// then
				expect($('#lightbox-demo').hasClass('lightbox-open')).to.equal(false);
			});


			it('Does NOT close when the lightbox itself is clicked', function() {
				givenTheLargeLightBoxIsOpen();
				// when
				$('#lightbox-demo .lightbox-content').click();
				// then
				expect($('#lightbox-demo').hasClass('lightbox-open')).to.equal(true);
			});


			it('Hides the double scrollbar from the body element', function() {
				givenTheLargeLightBoxIsOpen();
				// then
				expect($('body').is('[style]')).to.equal(true);
				expect($('body').css('overflow')).to.equal('hidden');
				// when
				$('#lightbox-demo .lightbox-close').click();
				// then
				expect($('body').is('[style]')).to.equal(false);
			});


			context('Focus Behaviour', function() {

				beforeEach(function() {
					$('#spec-markup').show();
				});

				afterEach(function() {
					$('#spec-markup').hide();
				});

				it('Gives focus to the close icon when opened', function() {
					givenTheLargeLightBoxIsOpen();
					// then
					expect(document.activeElement).to.equal($('#lightbox-demo .lightbox-close:focus')[0]);
				});

				it('Returns focus back to the ORIGINATOR when closed', function() {
					// given
					givenTheLargeLightBoxIsOpen();
					// when
					$('#lightbox-demo .lightbox-close').click();
					// then
					expect(document.activeElement).to.equal($('#lightbox-demo-text-link-for-large-lightbox:focus')[0]);
				});

				it("Sets the 'skycom-focus' class on the close icon if the ORIGINATOR had the 'skycom-focus' class.", function() {
					// given
					expect($('#lightbox-demo .lightbox-close').hasClass('skycom-focus')).to.equal(false);
					$('#lightbox-demo-text-link-for-large-lightbox').addClass('skycom-focus');
					givenTheLargeLightBoxIsOpen();
					// then
					expect($('#lightbox-demo .lightbox-close').hasClass('skycom-focus')).to.equal(true);
				});

				it('Constrains the tab focus to the lightbox', function() {
					givenTheLargeLightBoxIsOpen();
					expect(document.activeElement).to.equal($('#lightbox-demo .lightbox-close:focus')[0]);

					// then
					$.tabNext();
					expect(document.activeElement).to.equal($('#lightboxInput:focus')[0]);
					$.tabNext();	// tab to link
					$.tabNext();	// tab to link
					$.tabNext();	// tab should loop back to close icon
					expect(document.activeElement).to.equal($('#lightbox-demo .lightbox-close:focus')[0]);
				});
			});

			// TODO: hightlight the close icon (more) when focused

        });
        mocha.run();
    });
</script>

</body>
</html>